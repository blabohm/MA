st_read(quiet = TRUE, layer = lr[1]) %>%
st_transform(crs)
# check if tmp is inside boundary
isIn <- ifelse(is.null(boundary), TRUE,
any(st_intersects(tmp$geom, boundary, sparse = FALSE)))
# combine
if (isIn) outSF <- ifelse(is.null(outSF),
st_read(file, quiet = TRUE),
st_read(file, quiet = TRUE) %>%
bind_rows(outSF)) }
rm(tmp)
return(outSF)
}
# LOAD AND COMBINE NETWORK TILES
network <- combinator(netTiles, cityBoundary)
netTiles
listTiles <- function(network_tile_directory, city_code)
{
# load packages
require(dplyr, quietly = TRUE)
# list files and filter
network_tile_directory %>%
list.files(pattern = city_code, full.names = TRUE) %>%
tibble(path = .) %>%
filter(grepl(".gpkg$", path)) %>%
pull(path)
}
# LIST NETWORK TILES FOR FUA CODE
netTiles <- listTiles(netTileDir, cityCode)
# LOAD AND COMBINE NETWORK TILES
network <- combinator(netTiles, cityBoundary)
# best package in the world:
library(dplyr)
# also needed:
library(readxl)
library(tidyr)
# READ BARK BEETLE DATA
bb_df <-
read.csv("C:/GCG/uwp/q-team/data/bark_beetle_clean.csv")
# GET COUNT OF BARK BEETLE SPECIES PER TREE SPECIES
n_beetles <-
bb_df %>%
mutate(host_species = gsub(" sp.*.*", " ", host_species) %>% trimws(),
host_species = gsub("  ", " ", host_species)) %>%
group_by(host_species) %>%
tally() %>%
mutate(species_name = trimws(host_species)) %>%
filter(grepl(" ", species_name)) %>%
select(species_name, n)
# READ DROUGHT RESISTANCE DATA
drought_df <-
read.delim("C:/GCG/uwp/q-team/data/19141.txt") %>%
#filter(!is.na(TraitID)) %>%
as_tibble() %>%
select(species_name = AccSpeciesName, drought_res = OrigValueStr, Comment) %>%
mutate(species_name = trimws(species_name))
# CHECK FOR SPELLING ERROR IN SPECIES NAMES
n_beetles %>%
pivot_wider(species_name, " ")
# CHECK FOR SPELLING ERROR IN SPECIES NAMES
n_beetles %>%
pivot_wider(species_name, names_sep = " ")
# CHECK FOR SPELLING ERROR IN SPECIES NAMES
n_beetles %>%
pivot_wider(names_sep = " ")
# CHECK FOR SPELLING ERROR IN SPECIES NAMES
n_beetles %>%
pivot_wider(names_from = species_name, names_sep = " ")
# CHECK FOR SPELLING ERROR IN SPECIES NAMES
n_beetles %>%
select(species_name) %>%
pivot_wider(names_from = species_name, names_sep = " ")
# CHECK FOR SPELLING ERROR IN SPECIES NAMES
n_beetles %>%
select(species_name) %>%
pivot_wider(names_sep = " ")
# CHECK FOR SPELLING ERROR IN SPECIES NAMES
n_beetles %>%
select(species_name) %>%
seperate_rows(species_name, " ")
# CHECK FOR SPELLING ERROR IN SPECIES NAMES
n_beetles %>%
select(species_name) %>%
separate_rows(species_name, " ")
# CHECK FOR SPELLING ERROR IN SPECIES NAMES
n_beetles %>%
select(species_name) %>%
separate_rows(species_name, sep =  " ")
# CHECK FOR SPELLING ERROR IN SPECIES NAMES
n_beetles %>%
select(species_name) %>%
separate(species_name, sep =  " ", )
# CHECK FOR SPELLING ERROR IN SPECIES NAMES
n_beetles %>%
select(species_name) %>%
separate(species_name, sep =  " ", into = c("family", "species"))
# CHECK FOR SPELLING ERROR IN SPECIES NAMES
n_beetles %>%
select(species_name) %>%
separate(species_name, sep =  " ", into = c("family", "species", "subspecies"))
# CHECK FOR SPELLING ERROR IN SPECIES NAMES
n_beetles %>%
select(species_name) %>%
separate(species_name, sep =  " ", into = c("family", "species", "species1",
"species2",  "species3",  "species4"))
# CHECK FOR SPELLING ERROR IN SPECIES NAMES
comp_df <-
n_beetles %>%
select(species_name) %>%
separate(species_name, sep =  " ", into = c("family", "species", "species1",
"species2",  "species3",  "species4"))
# CHECK FOR SPELLING ERROR IN SPECIES NAMES
comp_df_beetles <-
n_beetles %>%
select(species_name) %>%
separate(species_name, sep =  " ", into = c("family", "species", "species1",
"species2",  "species3",  "species4"))
comp_df_drought <-
n_beetles %>%
select(species_name) %>%
distinct()
comp_df_drought <-
drought_df %>%
select(species_name) %>%
distinct()
comp_df_drought
comp_df_drought <-
drought_df %>%
select(species_name) %>%
distinct() %>%
separate(species_name, sep =  " ", into = c("family", "species", "species1",
"species2",  "species3",  "species4"))
View(comp_df_beetles)
View(comp_df_drought)
# CHECK FOR SPELLING ERROR IN SPECIES NAMES
comp_df_beetles <-
n_beetles %>%
select(species_name) %>%
separate(species_name, sep =  " ", into = c("family", "species", "species1",
"species2",  "species3",  "species4")) %>%
mutate(species_name = paste(family, species))
comp_df_drought <-
drought_df %>%
select(species_name) %>%
distinct() %>%
separate(species_name, sep =  " ", into = c("family", "species", "species1",
"species2",  "species3",  "species4")) %>%
mutate(species_name = paste(family, species))
drought_spec <-
comp_df_drought %>%
transmute(species_name = paste(family, species))
bb_spec <-
comp_df_beetles %>%
transmute(species_name = paste(family, species))
bb_spec <-
comp_df_beetles %>%
transmute(species_name = paste(family, species)) %>%
distinct()
drought_spec <-
comp_df_drought %>%
transmute(species_name = paste(family, species)) %>%
distinct()
bb_spec %>%
filter(species_name %in% drought_spec$species_name) %>% nrow()
filter(n_beetles$species_name %in% drought_df$species_name)
n_beetles %>% filter(species_name %in% drought_df$species_name) %>% nrow()
bb_spec <-
comp_df_beetles %>%
transmute(species_name = paste(family, species)) %>%
distinct() %>%
mutate(bb = TRUE)
drought_spec <-
comp_df_drought %>%
transmute(species_name = paste(family, species)) %>%
distinct() %>%
mutate(drought = TRUE)
full_join(drought_spec, bb_spec)
comp_df <- full_join(drought_spec, bb_spec)
View(comp_df)
comp_df %>%
filter(drought & bb)
install.packages("taxise")
install.packages("taxize")
library(taxize)
taxize::synonyms(bb_spec$species_name)
taxize::synonyms_df(bb_spec$species_name)
?syno
?synonyms
taxize::synonyms(bb_spec$species_name, db="itis")
bb_syn <-
taxize::synonyms(bb_spec$species_name, db="itis")
View(bb_syn)
bb_syn[["Abies subalpina"]][["syn_name"]]
bb_spec %>%
filter(substr(species_name, 1, 5) %in% substr(drought_spec$species_name, 1, 5)) %>% nrow()
bb_spec <-
comp_df_beetles %>%
transmute(species_name = paste(family, species)) %>%
distinct() %>%
mutate(bb = TRUE,
spec_nam_short = paste(family, substr(species, 1, 5)))
drought_spec <-
comp_df_drought %>%
transmute(species_name = paste(family, species)) %>%
distinct() %>%
mutate(drought = TRUE,
spec_nam_short = paste(family, substr(species, 1, 5)))
bb_spec <-
comp_df_beetles %>%
transmute(species_name = paste(family, species)) %>%
distinct() %>%
mutate(bb = TRUE,
spec_short = substr(species, 1, 5)
spec_nam_short = paste(family, spec_short))
bb_spec <-
comp_df_beetles %>%
transmute(species_name = paste(family, species)) %>%
distinct() %>%
mutate(bb = TRUE,
spec_short = substr(species, 1, 5),
spec_nam_short = paste(family, spec_short))
bb_spec <-
comp_df_beetles %>%
mutate(species_name = paste(family, species)) %>%
distinct() %>%
mutate(bb = TRUE,
spec_short = substr(species, 1, 5),
spec_nam_short = paste(family, spec_short))
drought_spec <-
comp_df_drought %>%
mutate(species_name = paste(family, species)) %>%
distinct() %>%
mutate(droght = TRUE,
spec_short = substr(species, 1, 5),
spec_nam_short = paste(family, spec_short))
bb_spec <-
comp_df_beetles %>%
mutate(species_name = paste(family, species)) %>%
distinct() %>%
mutate(bb = TRUE,
spec_short = substr(species, 1, 5),
spec_nam_short = paste(family, spec_short))
drought_spec
bb_spec %>%
filter(spec_name_short %in% drought_spec$spec_name_short) %>% nrow()
bb_spec %>%
filter(spec_nam_short %in% drought_spec$spec_nam_short) %>% nrow()
bb_spec %>%
filter(species_name %in% drought_spec$species_name) %>% nrow()
bb_spec <-
comp_df_beetles %>%
mutate(species_name = paste(family, species)) %>%
distinct() %>%
mutate(bb = TRUE,
spec_short = substr(species, 1, 5),
spec_nam_short = paste(family, spec_short)) %>%
select(species_name, spec_short)
bb_spec <-
comp_df_beetles %>%
mutate(species_name = paste(family, species)) %>%
distinct() %>%
mutate(bb = TRUE,
spec_short = substr(species, 1, 5),
spec_nam_short = paste(family, spec_short)) %>%
select(species_name, spec_nam_short)
drought_spec <-
comp_df_drought %>%
mutate(species_name = paste(family, species)) %>%
distinct() %>%
mutate(droght = TRUE,
spec_short = substr(species, 1, 5),
spec_nam_short = paste(family, spec_short)) %>%
select(species_name, spec_nam_short)
comp_df <- full_join(drought_spec, bb_spec)
comp_df <- full_join(drought_spec, bb_spec, by = "spec_nam_short")
View(comp_df)
# LIST NETWORK TILES FOR CITY CODE
# LOAD AND COMBINE NETWORK TILES
#    -> CHECK IF TILE IS INSIDE CITY CORE
#    -> COMBINE NETWORK TILES
# CLEAN NETWORK
#    -> DOUBLE ENTRIES
#    -> UNCONNECTED EDGES
################################################################################
# INPUT VALUES FOR TESTING CODE
# DATA DIRECTORIES FOR UA AND OSM DATA
boundaryFile <- "E:/citiesEurope/Cities.shp"
netTileDir <- "E:/osm_paths/"
# FUA CITY CODE
cityCode <- "DE001"
#buildingEntries(osm_directory = osm_dir, ua_directory = ua_dir,
#                city_code = cityCode)
################################################################################
# LOAD PACKAGES AND FUNCTIONS
require(dplyr, quietly = TRUE)
getwd() %>%
paste0("/tool/Module 2 - data preparation/functions/") %>%
list.files(pattern = "2-1[A-Za-z].*\\.R", full.names = TRUE) %>%
for (file in .) source(file)
getwd() %>%
paste0("/tool/Module 2 - data preparation/functions/") %>%
list.files(pattern = "2-1[A-Za-z].*\\.R", full.names = TRUE) %>%
for (file in .) source(file, quietly = TRUE)
# temp directory for output
tempdir()
# temp directory for output
tmpOut <- paste0(tempdir(), "\\\\tmp-path.gpkg")
tmpOut
# temp directory for output
tmpOut <- paste0(tempdir(), "\\tmp-path.gpkg")
tmpOut
combinator <- function(file_list, boundary = NULL, crs = 3035)
{
# load packages
require(dplyr, quietly = TRUE)
require(sf, quietly = TRUE)
# temp directory for output
tmpOut <- paste0(tempdir(), "\\tmp-path.gpkg")
if(dir.exists(tmpOut)) unlink(tmpOut)
# iterate through files
for (file in file_list) {
# check layers
lr <- st_layers(file)$name %>%
grep("line", .,
ignore.case = TRUE, value = TRUE)
# read file
tmp <- file %>%
st_read(quiet = TRUE, layer = lr[1]) %>%
st_transform(crs)
# check if tmp is inside boundary
isIn <- ifelse(is.null(boundary), TRUE,
any(st_intersects(tmp$geom, boundary, sparse = FALSE)))
# combine
if (isIn) tmp %>%
select(highway = matches("^highway$")) %>%
filter(!grepl("motorway", highway)) %>%
st_write(dsn = tmpOut, layer = "osm_paths",
quiet = TRUE, append = TRUE)}
# clear temp object
rm(tmp)
# read output and return
tmpOut %>%
st_read(quiet = TRUE) %>%
return()
}
# LOAD CITY CORE BOUNDARY
cityBoundary <- boundaryLoader(boundaryFile, cityCode)
cityBoundary
# LIST NETWORK TILES FOR FUA CODE
netTiles <- listTiles(netTileDir, cityCode)
# LOAD AND COMBINE NETWORK TILES
network <- combinator(netTiles, cityBoundary)
network
unlink(tmpOut)
st_write(network, "E:/network_test.gpkg")
combinator <- function(file_list, boundary = NULL, crs = 3035)
{
# load packages
require(dplyr, quietly = TRUE)
require(sf, quietly = TRUE)
# temp directory for output
tmpOut <- paste0(tempdir(), "\\tmp-path.gpkg")
if(dir.exists(tmpOut)) unlink(tmpOut)
# iterate through files
for (file in file_list) {
# check layers
lr <- st_layers(file)$name %>%
grep("line", .,
ignore.case = TRUE, value = TRUE)
# read file
tmp <- file %>%
st_read(quiet = TRUE, layer = lr[1]) %>%
st_transform(crs)
# check if tmp is inside boundary
isIn <- ifelse(is.null(boundary), TRUE,
any(st_intersects(tmp$geom, boundary, sparse = FALSE)))
# combine
if (isIn) tmp %>%
select(highway = matches("^highway$")) %>%
filter(!grepl("motorway", highway)) %>%
st_write(dsn = tmpOut, layer = "osm_paths",
quiet = TRUE, append = TRUE)}
# clear temp object
rm(tmp)
# read output and return
output <-
st_read(quiet = TRUE) %>%
st_filter(boundary, .pred = st_intersects)
unlink(tmpOut)
return(output)
}
# LOAD AND COMBINE NETWORK TILES
network <- combinator(netTiles, cityBoundary)
combinator <- function(file_list, boundary = NULL, crs = 3035)
{
# load packages
require(dplyr, quietly = TRUE)
require(sf, quietly = TRUE)
# temp directory for output
tmpOut <- paste0(tempdir(), "\\tmp-path.gpkg")
if(dir.exists(tmpOut)) unlink(tmpOut)
# iterate through files
for (file in file_list) {
# check layers
lr <- st_layers(file)$name %>%
grep("line", .,
ignore.case = TRUE, value = TRUE)
# read file
tmp <- file %>%
st_read(quiet = TRUE, layer = lr[1]) %>%
st_transform(crs)
# check if tmp is inside boundary
isIn <- ifelse(is.null(boundary), TRUE,
any(st_intersects(tmp$geom, boundary, sparse = FALSE)))
# combine
if (isIn) tmp %>%
select(highway = matches("^highway$")) %>%
filter(!grepl("motorway", highway)) %>%
st_write(dsn = tmpOut, layer = "osm_paths",
quiet = TRUE, append = TRUE)}
# clear temp object
rm(tmp)
# read output and return
output <- tmpOut %>%
st_read(quiet = TRUE) %>%
st_filter(boundary, .pred = st_intersects)
unlink(tmpOut)
return(output)
}
# LOAD AND COMBINE NETWORK TILES
network <- combinator(netTiles, cityBoundary)
st_write(network, "E:/network_test1.gpkg")
require(sf)
require(sfnetworks)
networkCleaner <- function(network, crs = 3035)
{
require(dplyr)
require(sf)
require(sfnetworks)
baseDir <- "C:/Berlin/"
net_clean <-
network %>%
st_transform(crs) %>%
distinct() %>%
st_cast("LINESTRING") %>%
as_sfnetwork() %>%
filter(group_components() == 1) %>%
activate("edges") %>%
as_tibble() %>%
st_as_sf() %>%
st_geometry() %>%
lapply(function(x) round(x, 0)) %>%
st_sfc(crs = 3035) %>%
as_sfnetwork() %>%
convert(to_spatial_smooth) %>%
convert(to_spatial_subdivision)
}
# CLEAN NETWORK
#    -> DOUBLE ENTRIES
#    -> UNCONNECTED EDGES
network %>% networkCleaner(network)
networkCleaner <- function(network, crs = 3035)
{
require(dplyr)
require(sf)
require(sfnetworks)
baseDir <- "C:/Berlin/"
net_clean <-
network %>%
st_transform(crs) %>%
distinct() %>%
st_cast("LINESTRING") %>%
as_sfnetwork() %>%
filter(group_components() == 1) %>%
activate("edges") %>%
as_tibble() %>%
st_as_sf() %>%
st_geometry() %>%
lapply(function(x) round(x, 0)) %>%
st_sfc(crs = 3035) %>%
as_sfnetwork() %>%
convert(to_spatial_smooth) %>%
convert(to_spatial_subdivision)
}
network
# CLEAN NETWORK
#    -> DOUBLE ENTRIES
#    -> UNCONNECTED EDGES
network %>% networkCleaner(network)
network %>%
st_transform(crs)
crs = 3035
require(dplyr)
require(sf)
require(sfnetworks)
network %>%
st_transform(crs)
network %>%
distinct() %>%
st_cast("LINESTRING") %>%
as_sfnetwork() %>%
filter(group_components() == 1) %>%
activate("edges") %>%
as_tibble() %>%
st_as_sf() %>%
st_geometry() %>%
lapply(function(x) round(x, 0)) %>%
st_sfc(crs = 3035) %>%
as_sfnetwork() %>%
convert(to_spatial_smooth) %>%
convert(to_spatial_subdivision) %>%
return()
